# READNE

## 概要
* このapplicationは, 大型液体シンチレータ実験KamLANDで用いられているAutoAlarmSystemをpythonに焼き直したものである.
  * [KamLAND](http://www.awa.tohoku.ac.jp/kamland/)で運用しているAutoAlarmSystemは独自言語である[KiNOKO](http://www.awa.tohoku.ac.jp/~sanshiro/kinoko/) にて提供されている
* これが24時間, 実験の運転状況を監視することで, 大規模実験におけるシフトの省力化に貢献すると期待される.
* 設計内容や動作に違いはあるものの, これは主に他実験への移植を前提として汎用的に書き下したつもりである.
* したがって, 各実験で用いる際には担当者が目的に合わせて改造・修正を加えることを前提としたサンプルコードとして提供を行う.
* 単純にpythonベースでGUIをつくるサンプルだと思うと, このままDAQ用のGUIにも転用は可能(のはず)



## 提供するもの
* pythonによるtkinterベースのGUIのサンプルコード

## 今回提供を見送ったもの
* モデムを通してapplicationから電話をかけるコード
  * これは少しコードが複雑であり, さらに別途USB接続できる通話用モデムが必要となる.
  * (KamLANDのAutoAlarmSystemでは実装されている)
  * Testがいささか困難である上に, モデムとパソコンの相性によっても接続が変わると予想されるので, 今回見送った.
  * 興味があれば"CTI 電話"などで検索をかけてみると良い
  * 電話をかけたければ, IP電話をかけられる外部サービス(有料)があるのでそちらを利用するのも手かもしれない.

## ユーザが用意するもの
* パソコン
  * 本ソースコードはmacOS(10.13.3)で開発した
  * 基本的に使用するパソコンには寄らないつもりで書いた. Unix系であれば特に問題はないはず.
  * 足りないものがあったらインストールしてください
* python3およびモジュールライブラリとしてtkinter
  * [anaconda3](https://www.anaconda.com) をインストールすることで, 必要なものは揃う
  * 今回の開発においてはpython3.6.3, tkinter8.6, およびanaconda1.6.5を使った
  * python2系でも基本的構造は変わらないが, print文など一部の動作が完全に一致しないので保証はしない
* sendmailコマンド
  * Unix系なら最初から入っていると思うけど, なければインストール--> /usr/sbin/sendmail
* 監視する対象からlogファイル等を持ってくるscript
  * RemotePCからファイルをscp等で持ってくる場合はRSA-keyの設定も必要
* 監視する対象のlogファイルを解析して, 状況を判定するscript
  * return値として(0: upgrating, 1:good, 2:bad, 3:disable, 4:low-level alarm)を指定してください.
* GUIの配置は使うOSとモジュール類のバージョンで多少異なるので, 自分の使う環境下に合わせてて微調整お願いします


## 使い方
`$ python ./main.py`

* 起動後, ShiftInfoタブにシフトの名前とメールアドレスを書き込む
* メールがちゃんと届くかは, TestMailボタンを押せば良い
* 監視項目を一時的に外す場合は, Configタブから必要なチェックを外す
* Updateボタンで監視項目の状況確認を, ユーザの設定するスクリプトで判定し, 結果を表示する
  * Updateを押さなくてもカウントダウンが0になったら, これを自動的に行う
* Stop/Startを押すと, カウントダウンが一時停止/再開する
* Quitを押すと, アプリが終了する
* あとは本アプリの出力情報をパイプを通してログとして残しておけば良い

`$ python ./main.py --help`

* helpを表示します.
* argparseモジュールでオプションおよび引数の制御ができます.　もちろんsys.argvで引数を持ってきても良いです

`$ python ./main.py --debug`

* debug-modeで起動します
* 基本的にscriptを変えたりした際に(scriptのミスなどで)メールを送信しまくることを防ぐため,`self.send_an_email()`の時にだけskipを行います
* AlarmSystem導入時の通常ユーザが間違ってdebug-modeで起動して待った場合のために, このモードではポップアップが出る仕様になっています

## 設計
**Coding rule**

  * 命名規則はについて, 変数, 関数名はスネーク法で書かれています. 定数変数については全て大文字のスネーク法を用います. ハンガリアンは使用しません.
  * tkinterクラス内でFrameやButtonなどのオブジェクトを宣言する際にはキャメル法を用いています.
  * タブは常にスペース4つです
  * 上記は筆者の趣味です
  * 本当はpep8に準拠させたかったけど, 階層構造を明確にしながら書いたらオブジェクト名がかなり長くなってしまったし, スペースと改行を適宜挟んだ方が見やすいと思ったので割りと無視してしまった


**./main.py**

  * GUIの本体
  * tkinterを用いてフレーム, ラベル, 入力エントリ, ボタン, チェックボタンを配置している
  * 階層構造をハッキリさせるべく, かなり冗長に書いたため, かなり横長なエディタウィンドウにしなければ読みづらくなってしまった. 申し訳ない.
  * 操作およびカウントダウンを行う. カウントダウンは内部変数`self.timerCounter`が持っているが, `Update()`を行う周期はグローバル変数である`CheckingInterval`で決められる
  * 一定周期毎にCheckingScript以下に用意したscriptでRemotePCなどの状況を確認し, ディスプレイに色分け表示する.
    * この際, サンプルでは全てpythonで書いた外部scriptをimportしているが, べた書きでも構わないし, 何ならc++で書いたって構わない
    * ただし返り値が(0=updating, 1=good, 2=bad, 3=disable, 4=lowlevel)になるようにする
      * 0はdefaultである
      * 4は例えば, 緊急事態ではないものの, 注意して見る必要があるときなどに使う
      * ユーザでstatusのフラグを増やしたって構わない.
  * bad判定された場合にはメール送信を行う
    * `mail_message`内の文章を変更することで, メール本文を変更可能
    * 宛先アドレスは, ShiftInfoタブのEntryから読み込んでいるが最初は`DEFAULT_MAIL`になっているので, 起動後に入力が必要である
    * 無論, 誰か担当者の連絡先をソースコード内の`DEFAULT_MAIL`に事前にべた書きしておくのが安全である
  * 監視する対象は, サンプルコードでは6つにしており(CheckTarget01~06), それぞれのラベルは3×3の配列に対して配置してある. 行跨ぎしているのは, こういうこともできますよっていうだけで特に意味はない
  * 監視対象のオブジェクト名をCheckTarget01~06とべた書きしてしまったが, numpyなどで配列にしてしまう方がソースコード上は書きやすいしobjectiveである
    * ただし長期的運用を見込む観点からして, CheckTarget01という名前を, 例えばDAQやHVなどといった実際の監視項目名として書いてしまった方が, 引き継ぎ時に可読性が上がる(と思っている)
  * 監視対象はあらかじめハードコーディングしておく必要があるが, 実際に運用時に, 一時的に監視対象から外しておきたい場合がある
    * このときはConfigタブからチェックを外すことで, 監視対象からはずせる
    * するとそのラベルのカラーはグレーとなる(Disable)
  * ConfigタブおよびShiftInfoタブ内の情報は, `WORKING_DIR`以下の`config.txt`に保存してあり(`self.save_last_config()`), 次回アプリケーションを起動する際に読み込む(`self.load_last_config()`)仕様になっている

**./main_tiny.py**

  * 基本的には`main.py`と同じですが, 機能を絞ってあります.
  

**./AlertScript/Mail.py**

  * 基本的には`/usr/sbin/sendmail`コマンドのwrapperにすぎない
  * BCCやCCなどの追加もできるので, 必要であれば調べて実装して欲しい

**./CheckingScript/CheckItemXX.py**

  * 各インターバル後に, 監視対象の状況を見るスクリプト
  * これはユーザが完全に設定すべきもので, 監視している対象がどんなログを吐いていて, ユーザが何をチェックしたいかに完全に依存するためである
  * 例えばKamLANDでは以下の流れをとる
    * まずRemotePCからデータ転送
    * その後状況を判定(ローカルファイル等に保存)
    * 過去10分程の状況判定結果の履歴を見て, 悪い状態が続いていれば異常事態とみなす
    * これは, 一時的な通信混雑や, 偶発的に設定した閾値を超える場合を取り除くためであり, よりSensitiveな判定を求めるのであれば, 状況判定結果をすぐにmain.pyへ返せば良い
  * 別にc言語で書いてもよい
    * `main.py`内でsubprocessモジュールを使って外部コマンドを叩いて返り値を取得すれば良い
 
**./CheckingScript/Sample001.py**

  * 実際にリモートPCからデータ転送を通して, ログファイル解析を行う際のスクリプトを用意した
  * 前提としては, 公開鍵をすでに準備していて, ログファイルのフォーマットが `[unixtime] [data]\n`という形を想定している
  * リモートPCへのssh接続時にDNSサーバが不安定だと, 公開鍵が効かずにパスフレーズを求められて固まる危険性があるが, その場合にはssh接続を行う子プロセスをterminateするように実装した
 

## 課題 ##
* モデムを通して電話をかけるprogram
  * 手元にUSBモデムがないので, 本アプリケーションでの実装テストができなかった
* もう少しきれいなGUI
  * 今回はtkinterを用いたが, macOS上ではそこそこキレイなものの, Linux上ではあまり美しくない
  * 他にもクロスプラットフォームなGUI作成には, wxPython, kivyなどがあるが, これらを使うために別途インストールしなければいけないものが多く, ユーザ側の準備が面倒だろうと考えて見送った
  * 今回の場合はanacondaをインストールすれば必要な物が揃うので楽である. と思っている. (Windowsでもコマンドラインとテキストエディタ等の必要な物が手に入る. sendmailコマンドは別途インストールが必要)

## Copyright##
  * OBARA shuhei (<obara.syuhei.asrtoparticle@gmail.com>)
  * First update on February 19th, 2018.
 